<!DOCTYPE html>
<html lang="en">

<head>
    <title>NotifySync Configuration</title>
</head>

<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-button,emby-input,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="notifySyncConfigForm">
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h2 class="sectionTitle">Configuration NotifySync</h2>
                            <p>G√©rez les notifications et les cat√©gories de la cloche.</p>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="maxItems">Quota par Cat√©gorie</label>
                            <input is="emby-input" type="number" id="maxItems" name="maxItems" min="3" max="20" />
                            <div class="fieldDescription">D√©finit le nombre d'√©l√©ments √† garder pour CHAQUE type (ex: 5
                                Films + 5 Animes + 5 Musiques).</div>
                        </div>

                        <div class="inputContainer">
                            <h3 class="sectionTitle">Biblioth√®ques Surveill√©es</h3>
                            <div class="fieldDescription">Cochez les biblioth√®ques √† afficher dans la cloche.</div>
                            <div id="libraryCheckboxes"
                                style="margin-top:10px; padding: 10px; background: rgba(0,0,0,0.2); min-height:50px;">
                                Chargement...
                            </div>
                        </div>

                        <div class="inputContainer">
                            <h3 class="sectionTitle">Mappage des Cat√©gories</h3>
                            <div class="fieldDescription">
                                Cr√©ez vos propres cat√©gories (ex: <b>Documentaires</b>, <b>Animes</b>).
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:10px; align-items:flex-end;">
                                <div style="flex-grow:1;">
                                    <label class="inputLabel">Biblioth√®que source</label>
                                    <select id="mappingLibrarySelect" is="emby-select" style="width:100%;"></select>
                                </div>
                                <div style="flex-grow:1;">
                                    <label class="inputLabel">Nom de la cat√©gorie cible</label>
                                    <input is="emby-input" id="mappingCategoryInput" placeholder="ex: Animes" />
                                </div>
                                <button type="button" is="emby-button" class="raised button-accent"
                                    onclick="NotifySyncConf.addMapping()" style="margin-bottom:5px;">
                                    Ajouter
                                </button>
                            </div>
                            <div id="mappingList"
                                style="background: rgba(0,0,0,0.1); border-radius: 4px; overflow:hidden;"></div>
                        </div>

                        <div class="inputContainer">
                            <h3 class="sectionTitle">S√©lection Manuelle (IDs ou Noms)</h3>
                            <div class="fieldDescription">
                                Si les cases ci-dessus ne fonctionnent pas, entrez ici l'ID <b>OU LE NOM EXACT</b> du
                                dossier.<br />
                                Exemples : <code>acf898...</code> ou simplement <code>Animes</code>.
                            </div>
                            <textarea is="emby-textarea" id="manualLibraryIds" name="manualLibraryIds"
                                rows="2"></textarea>
                        </div>

                        <div style="margin-top:30px;">
                            <button is="emby-button" type="submit" class="raised button-submit block"
                                style="margin-bottom:20px;">
                                Sauvegarder la configuration
                            </button>

                            <h3 class="sectionTitle">Maintenance</h3>
                            <p class="fieldDescription">Cliquez ici apr√®s avoir chang√© les biblioth√®ques pour forcer le
                                scan.</p>
                            <button is="emby-button" type="button" class="raised button-cancel block"
                                onclick="NotifySyncConf.refreshHistory()">
                                üîÑ R√©g√©n√©rer l'historique et appliquer les filtres
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var NotifySyncConf = {
                pluginId: "95655672-2342-4321-8291-321312312312",
                config: {},

                load: function (page) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(this.pluginId).then(function (cfg) {
                        NotifySyncConf.config = cfg || {};
                        NotifySyncConf.config.EnabledLibraries = NotifySyncConf.config.EnabledLibraries || [];
                        NotifySyncConf.config.CategoryMappings = NotifySyncConf.config.CategoryMappings || [];
                        NotifySyncConf.config.ManualLibraryIds = NotifySyncConf.config.ManualLibraryIds || [];

                        page.querySelector('#maxItems').value = NotifySyncConf.config.MaxItems || 5;
                        page.querySelector('#manualLibraryIds').value = NotifySyncConf.config.ManualLibraryIds.join(', ');

                        NotifySyncConf.renderLibs(page).then(function () {
                            NotifySyncConf.renderMap(page);
                            Dashboard.hideLoadingMsg();
                        });
                    });
                },

                refreshHistory: function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: "POST",
                        url: "/NotifySync/Refresh"
                    }).then(function () {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert({ message: "Historique r√©g√©n√©r√© ! V√©rifiez la cloche.", title: "Succ√®s" });
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        if (err && err.status === 429) {
                            Dashboard.alert({ message: "Veuillez patienter 30 secondes entre chaque rafra√Æchissement.", title: "Patience" });
                        } else {
                            Dashboard.alert({ message: "Erreur r√©g√©n√©ration.", title: "Erreur" });
                        }
                    });
                },

                renderLibs: function (page) {
                    var container = page.querySelector('#libraryCheckboxes');
                    var select = page.querySelector('#mappingLibrarySelect');
                    container.innerHTML = 'R√©cup√©ration...';

                    return ApiClient.getUserViews({}, ApiClient.getCurrentUserId()).then(function (result) {
                        var items = result.Items || [];
                        container.innerHTML = '';
                        select.innerHTML = '<option value="">-- Choisir une biblioth√®que --</option>';

                        if (items.length === 0) {
                            container.innerHTML = 'Aucune biblioth√®que trouv√©e via API.';
                            return;
                        }

                        items.sort(function (a, b) { return a.Name.localeCompare(b.Name); });

                        for (var i = 0; i < items.length; i++) {
                            var item = items[i];
                            if (item.CollectionType === 'boxsets' || item.CollectionType === 'playlists') continue;

                            var isChecked = NotifySyncConf.config.EnabledLibraries.indexOf(item.Id) !== -1;

                            var div = document.createElement('div');
                            div.style.marginBottom = "5px";
                            var label = document.createElement('label');
                            label.style.display = "flex";
                            label.style.alignItems = "center";
                            var checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.setAttribute('is', 'emby-checkbox');
                            checkbox.name = 'enabledLibs';
                            checkbox.value = item.Id;
                            if (isChecked) checkbox.checked = true;
                            var span = document.createElement('span');
                            span.style.marginLeft = "8px";
                            span.innerText = item.Name;

                            label.appendChild(checkbox);
                            label.appendChild(span);
                            div.appendChild(label);
                            container.appendChild(div);

                            var option = document.createElement('option');
                            option.value = item.Id;
                            option.innerText = item.Name;
                            select.appendChild(option);
                        }
                    });
                },

                renderMap: function (page) {
                    var l = page.querySelector('#mappingList'); l.innerHTML = '';
                    if (this.config.CategoryMappings.length === 0) {
                        l.innerHTML = '<div style="padding:10px; color:#888; font-style:italic;">Aucune cat√©gorie personnalis√©e d√©finie.</div>';
                        return;
                    }

                    for (var i = 0; i < this.config.CategoryMappings.length; i++) {
                        var m = this.config.CategoryMappings[i];
                        var libName = m.LibraryId;
                        var select = page.querySelector('#mappingLibrarySelect');
                        if (select) {
                            for (var k = 0; k < select.options.length; k++) {
                                if (select.options[k].value === m.LibraryId) { libName = select.options[k].text; break; }
                            }
                        }

                        var div = document.createElement('div');
                        div.style.padding = "10px";
                        div.style.borderBottom = "1px solid #333";
                        div.style.display = "flex";
                        div.style.justifyContent = "space-between";
                        div.style.alignItems = "center";

                        div.innerHTML = '<span>Biblioth√®que <b>' + libName + '</b> &rarr; <b style="color:#00a4dc;">' + m.CategoryName + '</b></span>';

                        var btn = document.createElement('button');
                        btn.type = 'button';
                        btn.innerText = 'Supprimer';
                        btn.style.color = 'red';
                        btn.setAttribute('data-index', i);
                        btn.onclick = function (e) {
                            NotifySyncConf.delMap(parseInt(e.target.getAttribute('data-index')));
                        };
                        div.appendChild(btn);
                        l.appendChild(div);
                    }
                },

                addMapping: function () {
                    var page = document.querySelector('.pluginConfigurationPage');
                    var lib = page.querySelector('#mappingLibrarySelect').value;
                    var cat = page.querySelector('#mappingCategoryInput').value;

                    if (lib && cat) {
                        this.config.CategoryMappings.push({ LibraryId: lib, CategoryName: cat });
                        this.renderMap(page);
                        page.querySelector('#mappingCategoryInput').value = '';
                    }
                },

                delMap: function (index) {
                    this.config.CategoryMappings.splice(index, 1);
                    this.renderMap(document.querySelector('.pluginConfigurationPage'));
                },

                save: function () {
                    Dashboard.showLoadingMsg();
                    var page = document.querySelector('.pluginConfigurationPage');
                    this.config.MaxItems = parseInt(page.querySelector('#maxItems').value);

                    var checkboxes = page.querySelectorAll('input[name="enabledLibs"]:checked');
                    var enabledList = [];
                    for (var i = 0; i < checkboxes.length; i++) {
                        enabledList.push(checkboxes[i].value);
                    }
                    this.config.EnabledLibraries = enabledList;

                    var manualStr = page.querySelector('#manualLibraryIds').value;
                    this.config.ManualLibraryIds = manualStr ? manualStr.split(',').map(function (s) { return s.trim(); }).filter(function (s) { return s; }) : [];

                    ApiClient.updatePluginConfiguration(this.pluginId, this.config).then(function (r) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.processPluginConfigurationUpdateResult(r);
                    });
                }
            };

            document.querySelector('#notifySyncConfigForm').addEventListener('submit', function (e) { e.preventDefault(); NotifySyncConf.save(); });
            document.addEventListener('pageshow', function (e) {
                if (e.target.classList.contains('pluginConfigurationPage')) NotifySyncConf.load(e.target);
            });
        </script>
    </div>
</body>

</html>