<!DOCTYPE html>
<html lang="en">
<head>
    <title>NotifySync Configuration</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-button,emby-input,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="notifySyncConfigForm">
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h2 class="sectionTitle">Configuration de la Cloche</h2>
                            <p>Choisissez les contenus à notifier.</p>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="maxItems">Nombre d'éléments</label>
                            <input is="emby-input" type="number" id="maxItems" name="maxItems" min="1" max="50" step="1" />
                            <div class="fieldDescription">Défaut : 5</div>
                        </div>

                        <div class="inputContainer">
                            <h3 class="sectionTitle">Bibliothèques Surveillées</h3>
                            <div class="fieldDescription">
                                <strong>Important :</strong> Si aucune case n'est cochée, TOUT est surveillé.
                            </div>
                            <div id="libraryCheckboxes" style="margin-top:10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; min-height: 50px;">
                                <em>Initialisation des bibliothèques...</em>
                            </div>
                        </div>

                        <div class="inputContainer">
                            <h3 class="sectionTitle">IDs Manuels (Secours)</h3>
                            <textarea is="emby-textarea" id="manualLibraryIds" name="manualLibraryIds" rows="2"></textarea>
                        </div>

                        <div class="verticalSection">
                            <h3 class="sectionTitle">Renommer les Catégories</h3>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <select id="mappingLibrarySelect" is="emby-select" style="flex-grow:1;"></select>
                                <input is="emby-input" id="mappingCategoryInput" placeholder="Nom (ex: Anime)" style="flex-grow:1;" />
                                <button type="button" is="emby-button" class="raised button-accent" onclick="NotifySyncConfigurationPage.addMapping()">Ajouter</button>
                            </div>
                            <div id="mappingList" style="display:flex; flex-direction:column; gap:5px;"></div>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block">
                                <span>Sauvegarder</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var NotifySyncConfigurationPage = {
                pluginId: "95655672-2342-4321-8291-321312312312",
                currentConfig: {},

                loadConfiguration: function (page) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(NotifySyncConfigurationPage.pluginId).then(function (config) {
                        NotifySyncConfigurationPage.currentConfig = config || {};
                        if (!NotifySyncConfigurationPage.currentConfig.EnabledLibraries) NotifySyncConfigurationPage.currentConfig.EnabledLibraries = [];
                        if (!NotifySyncConfigurationPage.currentConfig.CategoryMappings) NotifySyncConfigurationPage.currentConfig.CategoryMappings = [];

                        page.querySelector('#maxItems').value = config.MaxItems || 5;
                        page.querySelector('#manualLibraryIds').value = (config.ManualLibraryIds || []).join(', ');

                        NotifySyncConfigurationPage.fetchLibraries(page).then(function () {
                            NotifySyncConfigurationPage.renderMappings(page);
                            Dashboard.hideLoadingMsg();
                        });
                    }).catch(function(err) {
                        Dashboard.hideLoadingMsg();
                        page.querySelector('#libraryCheckboxes').innerHTML = '<div style="color:red; font-weight:bold;">Erreur Config: ' + err + '</div>';
                    });
                },

                fetchLibraries: function (page) {
                    return new Promise(function (resolve) {
                        var container = page.querySelector('#libraryCheckboxes');
                        var select = page.querySelector('#mappingLibrarySelect');
                        var enabledLibs = NotifySyncConfigurationPage.currentConfig.EnabledLibraries;

                        container.innerHTML = 'Chargement via API...';
                        select.innerHTML = '<option value="">-- Choisir une bibliothèque --</option>';

                        // SOLUTION ROBUSTE : Utiliser getItems sur le dossier ROOT
                        ApiClient.getItems(ApiClient.getCurrentUserId(), {
                            Recursive: false, 
                            ParentId: 'root',
                            SortBy: "SortName"
                        }).then(function (result) {
                            var folders = result.Items || [];
                            
                            if (folders.length === 0) {
                                container.innerHTML = '<div style="color:orange;">Aucune bibliothèque racine trouvée.</div>';
                                resolve(); return;
                            }
                            
                            container.innerHTML = ''; // Effacer le message de chargement

                            folders.forEach(function (folder) {
                                // On ignore les dossiers spéciaux comme "Collections" (boxsets) si on veut
                                if (folder.CollectionType === 'boxsets') return;

                                var isChecked = enabledLibs.indexOf(folder.Id) !== -1;
                                var div = document.createElement('div');
                                div.style.marginBottom = "5px";
                                div.innerHTML = '<label style="display:flex; align-items:center; cursor:pointer;">' +
                                    '<input is="emby-checkbox" type="checkbox" name="enabledLibs" value="' + folder.Id + '" ' + (isChecked ? 'checked' : '') + ' />' +
                                    '<span style="margin-left:10px; font-weight:500;">' + (folder.Name || "Sans nom") + '</span></label>';
                                container.appendChild(div);
                                
                                var option = document.createElement('option');
                                option.value = folder.Id; 
                                option.text = folder.Name;
                                select.appendChild(option);
                            });
                            resolve();
                        }).catch(function(err) {
                            console.error("NotifySync Lib Error:", err);
                            container.innerHTML = '<div style="color:red; background:rgba(255,0,0,0.1); padding:5px;">Erreur API JS : ' + err + '</div>';
                            // On resout quand même la promesse pour ne pas bloquer le reste de la page
                            resolve(); 
                        });
                    });
                },

                renderMappings: function (page) {
                    var list = page.querySelector('#mappingList');
                    list.innerHTML = '';
                    var mappings = NotifySyncConfigurationPage.currentConfig.CategoryMappings;

                    mappings.forEach(function (m, index) {
                        var div = document.createElement('div');
                        div.style.padding = "5px 10px"; div.style.background = "rgba(255,255,255,0.05)"; div.style.display = "flex"; div.style.alignItems = "center";
                        div.innerHTML = '<div style="flex-grow:1;">ID: <strong>' + m.LibraryId.substring(0,8) + '...</strong> &rarr; <span style="color:#64b5f6;">' + m.CategoryName + '</span></div>';
                        var btn = document.createElement('button');
                        btn.type = 'button'; btn.is = 'emby-button'; btn.className = 'raised button-delete'; btn.innerHTML = 'X'; btn.style.minWidth = "30px";
                        btn.onclick = function () { NotifySyncConfigurationPage.currentConfig.CategoryMappings.splice(index, 1); NotifySyncConfigurationPage.renderMappings(page); };
                        div.appendChild(btn); list.appendChild(div);
                    });
                },

                addMapping: function () {
                    var page = document.querySelector('.pluginConfigurationPage');
                    var libId = page.querySelector('#mappingLibrarySelect').value;
                    var catName = page.querySelector('#mappingCategoryInput').value.trim();
                    if (libId && catName) {
                        NotifySyncConfigurationPage.currentConfig.CategoryMappings = NotifySyncConfigurationPage.currentConfig.CategoryMappings.filter(m => m.LibraryId !== libId);
                        NotifySyncConfigurationPage.currentConfig.CategoryMappings.push({ LibraryId: libId, CategoryName: catName });
                        NotifySyncConfigurationPage.renderMappings(page);
                        page.querySelector('#mappingCategoryInput').value = '';
                    }
                },

                save: function () {
                    Dashboard.showLoadingMsg();
                    var page = document.querySelector('.pluginConfigurationPage');
                    ApiClient.getPluginConfiguration(NotifySyncConfigurationPage.pluginId).then(function (config) {
                        config.MaxItems = parseInt(page.querySelector('#maxItems').value) || 5;
                        var selected = [];
                        page.querySelectorAll('input[name="enabledLibs"]:checked').forEach(function(cb) { selected.push(cb.value); });
                        config.EnabledLibraries = selected;
                        var manualStr = page.querySelector('#manualLibraryIds').value;
                        config.ManualLibraryIds = manualStr ? manualStr.split(',').map(s => s.trim()).filter(s => s) : [];
                        config.CategoryMappings = NotifySyncConfigurationPage.currentConfig.CategoryMappings;
                        ApiClient.updatePluginConfiguration(NotifySyncConfigurationPage.pluginId, config).then(function (result) {
                            Dashboard.hideLoadingMsg(); Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                }
            };

            document.querySelector('#notifySyncConfigForm').addEventListener('submit', function (e) { e.preventDefault(); NotifySyncConfigurationPage.save(); return false; });
            document.addEventListener('pageshow', function (e) { if (e.detail.className && e.detail.className.indexOf('pluginConfigurationPage') != -1) { NotifySyncConfigurationPage.loadConfiguration(e.target); } });
        </script>
    </div>
</body>
</html>